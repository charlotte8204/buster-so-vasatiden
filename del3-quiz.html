<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quiz: Del 3 - Vasatiden</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#f1f5f9;--card:#fff;--text:#1e293b;--muted:#64748b;--accent:#2563eb;--success:#16a34a;--danger:#dc2626;--warning:#f59e0b;--sidebar-bg:#1e293b;--sidebar-text:#e2e8f0;--radius:10px;--shadow:0 2px 12px rgba(0,0,0,.08)}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;font-size:18px;line-height:1.7;color:var(--text);background:var(--bg);display:flex;min-height:100vh}
.sidebar{width:220px;background:var(--sidebar-bg);color:var(--sidebar-text);padding:20px 0;flex-shrink:0;display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;overflow-y:auto}
.sidebar .logo{padding:0 16px 16px;font-weight:800;font-size:1.1em;border-bottom:1px solid #334155}.sidebar .logo a{color:var(--sidebar-text);text-decoration:none}
.sidebar nav{padding:12px 0;flex:1}
.sidebar .section-title{padding:8px 16px;font-size:.7em;text-transform:uppercase;letter-spacing:1px;color:#94a3b8;margin-top:8px}
.sidebar a{display:flex;align-items:center;gap:8px;padding:7px 16px;color:#cbd5e1;text-decoration:none;font-size:.85em;transition:background .15s}
.sidebar a:hover{background:#334155}.sidebar a.active{background:var(--accent);color:#fff;font-weight:600}.sidebar a.done .icon{color:var(--success)}
.sidebar .progress-box{padding:12px 16px;border-top:1px solid #334155;margin-top:auto}
.sidebar .progress-box .bar{height:6px;background:#334155;border-radius:3px;overflow:hidden;margin-top:6px}
.sidebar .progress-box .bar-fill{height:100%;background:var(--success);border-radius:3px;transition:width .3s}
.sidebar .progress-box span{font-size:.7em;color:#94a3b8}
.main{margin-left:220px;flex:1;display:flex;flex-direction:column;min-height:100vh}
.topbar{display:flex;justify-content:space-between;align-items:center;padding:12px 28px;background:var(--card);border-bottom:1px solid #e2e8f0}
.topbar .breadcrumb{font-size:.8em;color:var(--muted)}.topbar .breadcrumb a{color:var(--accent);text-decoration:none}
.topbar .points{font-weight:700;color:var(--warning);font-size:.95em}

.content{max-width:700px;margin:0 auto;padding:28px 32px}
.content h1{font-size:1.5em;font-weight:800;margin-bottom:4px;color:var(--sidebar-bg)}
.content .subtitle{font-size:.85em;color:var(--muted);margin-bottom:8px}

.quiz-info{background:#fef3c7;border:2px solid #fbbf24;border-radius:var(--radius);padding:14px 18px;margin-bottom:20px;font-size:.9em;color:#92400e}

/* Question stepper */
.q-progress{display:flex;gap:6px;margin-bottom:20px}
.q-dot{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.85em;border:2px solid #e2e8f0;color:var(--muted);background:var(--card)}
.q-dot.active{border-color:var(--accent);color:var(--accent);background:#dbeafe}
.q-dot.correct{border-color:var(--success);color:#fff;background:var(--success)}
.q-dot.wrong{border-color:var(--danger);color:#fff;background:var(--danger)}
.q-dot.partial{border-color:var(--warning);color:#fff;background:var(--warning)}

/* Question cards */
.q-card{display:none;background:var(--card);border-radius:var(--radius);padding:24px;box-shadow:var(--shadow);margin-bottom:16px}
.q-card.active{display:block}
.q-card h3{font-size:1em;margin-bottom:14px;color:var(--sidebar-bg)}
.badge{display:inline-block;font-size:.65em;padding:2px 8px;border-radius:4px;font-weight:700;margin-bottom:8px;text-transform:uppercase}
.badge-e{background:#dcfce7;color:var(--success)}
.badge-c{background:#dbeafe;color:var(--accent)}
.badge-a{background:#fef3c7;color:#92400e}

.options{display:flex;flex-direction:column;gap:8px}
.option-btn{display:block;width:100%;text-align:left;padding:12px 16px;border:2px solid #e2e8f0;border-radius:8px;background:var(--card);cursor:pointer;font-size:.9em;font-family:inherit;transition:border-color .15s,background .15s}
.option-btn:hover:not(:disabled){border-color:var(--accent);background:#f0f6ff}
.option-btn.correct{border-color:var(--success);background:#dcfce7}.option-btn.wrong{border-color:var(--danger);background:#fee2e2}.option-btn:disabled{cursor:default}

/* Fill in */
.fill-input{width:200px;padding:8px 12px;border:2px solid #e2e8f0;border-radius:6px;font-family:inherit;font-size:.9em}
.fill-input:focus{border-color:var(--accent);outline:none}
.fill-input.correct{border-color:var(--success);background:#dcfce7}
.fill-input.wrong{border-color:var(--danger);background:#fee2e2}
.fill-submit{padding:8px 16px;background:var(--accent);color:#fff;border:none;border-radius:6px;cursor:pointer;font-family:inherit;font-size:.85em;font-weight:600;margin-left:8px}

/* Open answer */
.open-answer{width:100%;min-height:70px;padding:12px;border:2px solid #e2e8f0;border-radius:8px;font-family:inherit;font-size:.9em;resize:vertical;line-height:1.5}
.open-answer:focus{border-color:var(--accent);outline:none}
.word-count{font-size:.75em;color:var(--muted);margin-top:4px}
.submit-open{margin-top:10px;padding:10px 20px;background:var(--accent);color:#fff;border:none;border-radius:8px;font-size:.9em;cursor:pointer;font-family:inherit;font-weight:600}
.submit-open:disabled{opacity:.4;cursor:not-allowed}
.compare-box{display:none;margin-top:14px;padding:16px;background:#f8fafc;border-radius:8px;border:1px solid #e2e8f0}
.compare-box.show{display:block}
.compare-box h4{font-size:.85em;margin-bottom:8px;color:var(--muted)}
.compare-box .model-answer{background:#f0fdf4;padding:10px;border-radius:6px;font-size:.9em;margin-top:8px}
.self-assess{margin-top:12px;display:flex;gap:8px}
.self-assess button{padding:8px 16px;border-radius:6px;border:2px solid #e2e8f0;background:var(--card);cursor:pointer;font-family:inherit;font-size:.85em;font-weight:600}
.self-assess .yes-btn:hover{border-color:var(--success);background:#dcfce7}

/* True/false */
.tf-group{margin-bottom:12px}
.tf-statement{font-size:.9em;margin-bottom:6px}
.tf-btns{display:flex;gap:8px}
.tf-btn{padding:6px 18px;border:2px solid #e2e8f0;border-radius:6px;background:var(--card);cursor:pointer;font-family:inherit;font-size:.85em;font-weight:600}
.tf-btn:hover:not(:disabled){border-color:var(--accent);background:#f0f6ff}
.tf-btn.correct{border-color:var(--success);background:#dcfce7}.tf-btn.wrong{border-color:var(--danger);background:#fee2e2}.tf-btn:disabled{cursor:default;opacity:.6}

.feedback{margin-top:12px;padding:12px 16px;border-radius:8px;font-size:.9em;display:none}
.feedback.show{display:block}
.feedback.correct{background:#dcfce7;color:#166534}
.feedback.wrong{background:#fee2e2;color:#991b1b}

.hint-btn{background:none;border:none;color:var(--accent);cursor:pointer;font-size:.8em;margin-top:8px;font-family:inherit;text-decoration:underline}
.hint-box{margin-top:8px;padding:8px 12px;background:#f0f6ff;border-radius:6px;font-size:.85em;display:none}.hint-box.show{display:block}

.next-q-btn{margin-top:14px;padding:10px 20px;background:var(--accent);color:#fff;border:none;border-radius:8px;font-size:.9em;cursor:pointer;font-family:inherit;font-weight:600;display:none}
.next-q-btn.show{display:inline-block}

/* Results */
.results{display:none;background:var(--card);border-radius:var(--radius);padding:28px;box-shadow:var(--shadow);text-align:center}
.results.show{display:block}
.results h2{font-size:1.4em;margin-bottom:16px}
.results .score{font-size:2.5em;font-weight:800;margin:12px 0}
.results .score.great{color:var(--success)}
.results .score.good{color:var(--accent)}
.results .score.ok{color:var(--warning)}
.results .detail{font-size:.9em;color:var(--muted);margin-bottom:20px}
.result-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:16px 0;text-align:left}
.result-item{padding:10px 14px;border-radius:8px;font-size:.85em}
.result-item.right{background:#dcfce7;color:#166534}
.result-item.wrong{background:#fee2e2;color:#991b1b}
.result-item.partial{background:#fef3c7;color:#92400e}

.nav-buttons{display:flex;justify-content:space-between;align-items:center;margin-top:24px;padding-top:16px;border-top:1px solid #e2e8f0}
.nav-btn{padding:10px 24px;border-radius:8px;font-size:.9em;font-weight:600;cursor:pointer;font-family:inherit;text-decoration:none;border:none;display:inline-flex;align-items:center;gap:6px}
.nav-btn.secondary{background:#f1f5f9;color:var(--text)}.nav-btn.secondary:hover{background:#e2e8f0}
.nav-btn.primary{background:var(--success);color:#fff}.nav-btn.primary:hover{background:#15803d}
.nav-btn.locked{opacity:.35;cursor:not-allowed;pointer-events:none}

@media(max-width:960px){.sidebar{width:180px}.main{margin-left:180px}}
@media(max-width:768px){.sidebar{display:none}.main{margin-left:0}.content{padding:20px}}
</style>
</head>
<body>
<div class="sidebar">
  <div class="logo"><a href="index.html">Vasatiden</a></div>
  <nav>
    <div class="section-title">Del 3: Sverige blir protestantiskt</div>
    <a href="del3-01-kritik-mot-kyrkan.html" id="nav-del3-01"><span class="icon">&#9675;</span> Kritik mot kyrkan</a>
    <a href="del3-02-martin-luther.html" id="nav-del3-02"><span class="icon">&#9675;</span> Martin Luther</a>
    <a href="del3-03-olaus-petri.html" id="nav-del3-03"><span class="icon">&#9675;</span> Olaus Petri</a>
    <a href="del3-04-kungen-tar-kyrkans-saker.html" id="nav-del3-04"><span class="icon">&#9675;</span> Kungen tar kyrkans saker</a>
    <a href="del3-05-klockupproret.html" id="nav-del3-05"><span class="icon">&#9675;</span> Klockupproret</a>
    <a href="del3-quiz.html" class="active" id="nav-del3-quiz"><span class="icon">&#9654;</span> Quiz: Del 3</a>
  </nav>
  <div class="progress-box">
    <span>Del 3: <span id="progressText">0/6</span></span>
    <div class="bar"><div class="bar-fill" id="progressBar" style="width:0%"></div></div>
  </div>
</div>

<div class="main">
  <div class="topbar">
    <div class="breadcrumb"><a href="index.html">Vasatiden</a> &rsaquo; Del 3 &rsaquo; Quiz</div>
    <div class="points" id="pointsDisplay">0 p</div>
  </div>

  <div class="content" id="contentArea">
    <h1>Quiz: Sverige blir protestantiskt</h1>
    <div class="subtitle">Svara utan att titta tillbaka p&aring; texterna!</div>

    <div class="quiz-info">
      Dags att testa vad du kan om reformationen! Ingen text att titta p&aring; &ndash; bara din kunskap. 7 fr&aring;gor, blandade niv&aring;er (E, C, A). Lycka till, Buster!
    </div>

    <!-- Progress dots -->
    <div class="q-progress" id="qProgress">
      <div class="q-dot active" id="dot0">1</div>
      <div class="q-dot" id="dot1">2</div>
      <div class="q-dot" id="dot2">3</div>
      <div class="q-dot" id="dot3">4</div>
      <div class="q-dot" id="dot4">5</div>
      <div class="q-dot" id="dot5">6</div>
      <div class="q-dot" id="dot6">7</div>
    </div>

    <!-- Q1: E-level MC -->
    <div class="q-card active" id="q0">
      <span class="badge badge-e">Niv&aring; E</span>
      <h3>Vad &auml;r ett avlatsbrev?</h3>
      <div class="options">
        <button class="option-btn" onclick="answerMC(0,0)">Ett brev fr&aring;n kungen</button>
        <button class="option-btn" onclick="answerMC(0,1)">Ett papper man k&ouml;pte fr&aring;n kyrkan f&ouml;r att bli f&ouml;rl&aring;ten f&ouml;r synder</button>
        <button class="option-btn" onclick="answerMC(0,2)">En inbjudan till fest</button>
      </div>
      <button class="hint-btn" onclick="showHint(0)">Ledtr&aring;d</button>
      <div class="hint-box" id="hint0">Kyrkan s&aring;lde n&aring;got som skulle ge f&ouml;rl&aring;telse...</div>
      <div class="feedback correct" id="fb0-correct">R&auml;tt! Avlatsbrev var papper som kyrkan s&aring;lde &ndash; man k&ouml;pte sig fri fr&aring;n synder.</div>
      <div class="feedback wrong" id="fb0-wrong">Nej, avlatsbrev var papper som kyrkan s&aring;lde f&ouml;r att ge f&ouml;rl&aring;telse f&ouml;r synder.</div>
      <button class="next-q-btn" id="next0" onclick="nextQ(1)">N&auml;sta fr&aring;ga &rarr;</button>
    </div>

    <!-- Q2: C-level MC -->
    <div class="q-card" id="q1">
      <span class="badge badge-c">Niv&aring; C</span>
      <h3>Varf&ouml;r var det viktigt att Bibeln &ouml;versattes till svenska?</h3>
      <div class="options">
        <button class="option-btn" onclick="answerMC(1,0)">Den blev tjockare</button>
        <button class="option-btn" onclick="answerMC(1,1)">Vanligt folk kunde f&ouml;rst&aring; och tolka Bibeln sj&auml;lva, ist&auml;llet f&ouml;r att lita p&aring; pr&auml;sterna</button>
        <button class="option-btn" onclick="answerMC(1,2)">Den var vackrare p&aring; svenska</button>
      </div>
      <button class="hint-btn" onclick="showHint(1)">Ledtr&aring;d</button>
      <div class="hint-box" id="hint1">Om bara pr&auml;sterna f&ouml;rstod Bibeln, vem hade d&aring; makten &ouml;ver vad som stod i den?</div>
      <div class="feedback correct" id="fb1-correct">R&auml;tt! N&auml;r Bibeln fanns p&aring; svenska kunde vanligt folk l&auml;sa och f&ouml;rst&aring; den sj&auml;lva, utan att beh&ouml;va lita p&aring; pr&auml;sternas tolkning.</div>
      <div class="feedback wrong" id="fb1-wrong">Inte riktigt. Det handlade om att vanligt folk &auml;ntligen kunde l&auml;sa och f&ouml;rst&aring; Bibeln sj&auml;lva.</div>
      <button class="next-q-btn" id="next1" onclick="nextQ(2)">N&auml;sta fr&aring;ga &rarr;</button>
    </div>

    <!-- Q3: E-level fill-in -->
    <div class="q-card" id="q2">
      <span class="badge badge-e">Niv&aring; E</span>
      <h3>Fyll i: Den tyske pr&auml;st som startade protestantismen hette Martin ___</h3>
      <div style="display:flex;align-items:center;margin-top:10px">
        <input class="fill-input" id="fill2" type="text" placeholder="Skriv h&auml;r...">
        <button class="fill-submit" onclick="answerFill(2)">Kolla</button>
      </div>
      <button class="hint-btn" onclick="showHint(2)">Ledtr&aring;d</button>
      <div class="hint-box" id="hint2">Hans efternamn b&ouml;rjar p&aring; L...</div>
      <div class="feedback correct" id="fb2-correct">R&auml;tt! Martin Luther.</div>
      <div class="feedback wrong" id="fb2-wrong">Svaret &auml;r &quot;Luther&quot; &ndash; Martin Luther.</div>
      <button class="next-q-btn" id="next2" onclick="nextQ(3)">N&auml;sta fr&aring;ga &rarr;</button>
    </div>

    <!-- Q4: C-level MC -->
    <div class="q-card" id="q3">
      <span class="badge badge-c">Niv&aring; C</span>
      <h3>Varf&ouml;r ville Gustav Vasa ha kyrkans saker?</h3>
      <div class="options">
        <button class="option-btn" onclick="answerMC(3,0)">Han samlade p&aring; vackra saker</button>
        <button class="option-btn" onclick="answerMC(3,1)">Han beh&ouml;vde pengar och kyrkans silver/jord var ett s&auml;tt att fylla statskassan</button>
        <button class="option-btn" onclick="answerMC(3,2)">Han var arg p&aring; pr&auml;sterna personligen</button>
      </div>
      <button class="hint-btn" onclick="showHint(3)">Ledtr&aring;d</button>
      <div class="hint-box" id="hint3">Gustav Vasa hade stora skulder efter befrielsekriget. Var kunde han hitta pengar?</div>
      <div class="feedback correct" id="fb3-correct">R&auml;tt! Gustav Vasa beh&ouml;vde desperat pengar, och kyrkan var den rikaste organisationen i Sverige.</div>
      <div class="feedback wrong" id="fb3-wrong">Det handlade om pengar. Gustav Vasa beh&ouml;vde fylla statskassan &ndash; och kyrkan hade massor.</div>
      <button class="next-q-btn" id="next3" onclick="nextQ(4)">N&auml;sta fr&aring;ga &rarr;</button>
    </div>

    <!-- Q5: A-level open -->
    <div class="q-card" id="q4">
      <span class="badge badge-a">Niv&aring; A &ndash; Utmaning (+20p)</span>
      <h3>Gustav Vasa anv&auml;nde reformationen f&ouml;r att st&auml;rka sin egen makt. Tycker du att det var smart eller var det fel? Resonera.</h3>
      <textarea class="open-answer" id="open4" placeholder="Skriv ditt resonemang..." oninput="updateWC4()"></textarea>
      <div class="word-count" id="wc4">0 ord (minst 15)</div>
      <button class="submit-open" id="submit4" onclick="submitOpen(4)" disabled>Visa facit</button>
      <button class="hint-btn" onclick="showHint(4)">Ledtr&aring;d</button>
      <div class="hint-box" id="hint4">T&auml;nk p&aring; b&aring;da sidorna: det var effektivt men kanske inte hed&auml;rligt...</div>
      <div class="compare-box" id="compare4">
        <h4>Exempelsvar:</h4>
        <div class="model-answer">Man kan se det som smart &ndash; han l&ouml;ste sina ekonomiska problem och fick mer makt. Men det var ocks&aring; cyniskt &ndash; han anv&auml;nde religion som verktyg f&ouml;r politisk makt, inte f&ouml;r att han verkligen trodde p&aring; de nya id&eacute;erna.</div>
        <div class="self-assess" id="sa4">
          <button class="yes-btn" onclick="selfAssessQuiz(4,true)">Jag fick med det viktiga</button>
          <button class="yes-btn" onclick="selfAssessQuiz(4,false)" style="background:#fefce8">Jag missade en del</button>
        </div>
      </div>
      <button class="next-q-btn" id="next4" onclick="nextQ(5)">N&auml;sta fr&aring;ga &rarr;</button>
    </div>

    <!-- Q6: E-level true/false -->
    <div class="q-card" id="q5">
      <span class="badge badge-e">Niv&aring; E &ndash; Sant eller falskt</span>
      <h3>Ange om f&ouml;ljande p&aring;st&aring;enden &auml;r sanna eller falska:</h3>

      <div class="tf-group" id="tf5a">
        <div class="tf-statement">&quot;Klockupproret var ett uppror i Dalarna&quot;</div>
        <div class="tf-btns">
          <button class="tf-btn" onclick="answerTF('5a',true)">Sant</button>
          <button class="tf-btn" onclick="answerTF('5a',false)">Falskt</button>
        </div>
      </div>

      <div class="tf-group" id="tf5b">
        <div class="tf-statement">&quot;Martin Luther uppmuntrade bondeuppror&quot;</div>
        <div class="tf-btns">
          <button class="tf-btn" onclick="answerTF('5b',true)">Sant</button>
          <button class="tf-btn" onclick="answerTF('5b',false)">Falskt</button>
        </div>
      </div>

      <div class="tf-group" id="tf5c">
        <div class="tf-statement">&quot;Olaus Petri &ouml;versatte Bibeln till svenska&quot;</div>
        <div class="tf-btns">
          <button class="tf-btn" onclick="answerTF('5c',true)">Sant</button>
          <button class="tf-btn" onclick="answerTF('5c',false)">Falskt</button>
        </div>
      </div>

      <div class="feedback correct" id="fb5-correct">Bra jobbat! Du fick alla r&auml;tt.</div>
      <div class="feedback wrong" id="fb5-wrong"></div>
      <button class="next-q-btn" id="next5" onclick="nextQ(6)">N&auml;sta fr&aring;ga &rarr;</button>
    </div>

    <!-- Q7: A-level MC -->
    <div class="q-card" id="q6">
      <span class="badge badge-a">Niv&aring; A</span>
      <h3>Vad &auml;r den viktigaste likheten mellan Stockholms blodbad och klockupproret?</h3>
      <div class="options">
        <button class="option-btn" onclick="answerMC(6,0)">B&aring;da h&auml;nde i Stockholm</button>
        <button class="option-btn" onclick="answerMC(6,1)">B&aring;da visar att den som har makten kan anv&auml;nda v&aring;ld mot folk som protesterar</button>
        <button class="option-btn" onclick="answerMC(6,2)">B&aring;da handlade om religion</button>
      </div>
      <button class="hint-btn" onclick="showHint(6)">Ledtr&aring;d</button>
      <div class="hint-box" id="hint6">T&auml;nk p&aring; vad som h&auml;nde med de som protesterade i b&aring;da fallen...</div>
      <div class="feedback correct" id="fb6-correct">Exakt! B&aring;da h&auml;ndelserna visar att makthavare anv&auml;nde v&aring;ld f&ouml;r att krossa motst&aring;nd. Makt och v&aring;ld h&auml;nger ihop.</div>
      <div class="feedback wrong" id="fb6-wrong">Inte riktigt. Den viktigaste likheten &auml;r att b&aring;da visar hur makthavare anv&auml;nder v&aring;ld mot de som protesterar.</div>
      <button class="next-q-btn" id="next6" onclick="showResults()">Se resultat &rarr;</button>
    </div>

    <!-- RESULTS -->
    <div class="results" id="resultsBox">
      <h2>Resultat: Del 3</h2>
      <div class="score" id="scoreText"></div>
      <div class="detail" id="scoreDetail"></div>
      <div class="result-grid" id="resultGrid"></div>
      <div class="nav-buttons" style="border:none;padding-top:0">
        <a href="del3-01-kritik-mot-kyrkan.html" class="nav-btn secondary">&larr; Klockupproret</a>
        <a href="index.html" class="nav-btn primary">Tillbaka till &ouml;versikten &rarr;</a>
      </div>
    </div>
  </div>
</div>

<script>
const PREFIX='buster-vasatiden-';
const PAGE_ID='del3-quiz';
let currentQ=0;
let qResults=[null,null,null,null,null,null,null]; // 7 questions
let qPoints=[0,0,0,0,0,0,0];
let hintsUsed=[0,0,0,0,0,0,0];
let totalQuizPoints=0;
let startTime=Date.now();

// MC correct answers: q0=1, q1=1, q3=1, q6=1
const MC_CORRECT={0:1, 1:1, 3:1, 6:1};

// TF tracking
let tfAnswers={};
const TF_CORRECT={'5a':true, '5b':false, '5c':true};
let tfCount=0;

function getPoints(){return parseInt(localStorage.getItem(PREFIX+'points')||'0')}
function addPoints(n){const p=getPoints()+n;localStorage.setItem(PREFIX+'points',p.toString());updatePointsDisplay();totalQuizPoints+=n;return p;}
function updatePointsDisplay(){document.getElementById('pointsDisplay').textContent=getPoints()+' p';}
function getProgress(){return JSON.parse(localStorage.getItem(PREFIX+'progress')||'{}')}
function markComplete(){const p=getProgress();p[PAGE_ID]=true;localStorage.setItem(PREFIX+'progress',JSON.stringify(p));updateNav();}
function saveStats(){
  const stats=JSON.parse(localStorage.getItem(PREFIX+'pageStats')||'{}');
  stats[PAGE_ID]={time:Math.round((Date.now()-startTime)/1000),results:qResults,points:totalQuizPoints,hintsPerQ:hintsUsed,timestamp:new Date().toISOString()};
  localStorage.setItem(PREFIX+'pageStats',JSON.stringify(stats));
}

function answerMC(qIdx, choice){
  const card=document.getElementById('q'+qIdx);
  const btns=card.querySelectorAll('.option-btn');
  if(btns[0].disabled)return;

  const correct=MC_CORRECT[qIdx]===choice;
  if(correct){
    btns[choice].classList.add('correct');
    document.getElementById('fb'+qIdx+'-correct').classList.add('show');
    const pts=hintsUsed[qIdx]>0?5:10;
    addPoints(pts);
    qResults[qIdx]=true;
    qPoints[qIdx]=pts;
  } else {
    btns[choice].classList.add('wrong');
    btns[MC_CORRECT[qIdx]].classList.add('correct');
    document.getElementById('fb'+qIdx+'-wrong').classList.add('show');
    qResults[qIdx]=false;
    qPoints[qIdx]=0;
  }
  btns.forEach(b=>b.disabled=true);
  updateDot(qIdx, correct);
  document.getElementById('next'+qIdx).classList.add('show');
}

function answerFill(qIdx){
  const input=document.getElementById('fill'+qIdx);
  const val=input.value.trim().toLowerCase();
  if(!val)return;

  if(qIdx===2){
    const correct=val.includes('luther');
    if(correct){
      input.classList.add('correct');
      document.getElementById('fb2-correct').classList.add('show');
      const pts=hintsUsed[2]>0?5:10;
      addPoints(pts);
      qResults[2]=true;qPoints[2]=pts;
      updateDot(2,true);
    } else {
      input.classList.add('wrong');
      document.getElementById('fb2-wrong').classList.add('show');
      qResults[2]=false;qPoints[2]=0;
      updateDot(2,false);
    }
    input.disabled=true;
    document.getElementById('next2').classList.add('show');
  }
}

function answerTF(id, val){
  if(tfAnswers[id]!==undefined)return;
  tfAnswers[id]=val;
  tfCount++;

  const group=document.getElementById('tf'+id);
  const btns=group.querySelectorAll('.tf-btn');
  const correct=val===TF_CORRECT[id];

  if(correct){
    btns[val?0:1].classList.add('correct');
  } else {
    btns[val?0:1].classList.add('wrong');
    btns[TF_CORRECT[id]?0:1].classList.add('correct');
  }
  btns.forEach(b=>b.disabled=true);

  if(tfCount===3){
    // All answered
    const allCorrect=Object.keys(TF_CORRECT).every(k=>tfAnswers[k]===TF_CORRECT[k]);
    const correctCount=Object.keys(TF_CORRECT).filter(k=>tfAnswers[k]===TF_CORRECT[k]).length;

    if(allCorrect){
      const pts=hintsUsed[5]>0?5:10;
      addPoints(pts);
      qResults[5]=true;qPoints[5]=pts;
      document.getElementById('fb5-correct').classList.add('show');
      updateDot(5,true);
    } else if(correctCount>=2){
      addPoints(5);
      qResults[5]='partial';qPoints[5]=5;
      document.getElementById('fb5-wrong').textContent=correctCount+'/3 r\u00e4tt. N\u00e4stan!';
      document.getElementById('fb5-wrong').classList.add('show');
      updateDot(5,'partial');
    } else {
      qResults[5]=false;qPoints[5]=0;
      document.getElementById('fb5-wrong').textContent=correctCount+'/3 r\u00e4tt. L\u00e4s om Del 3 igen!';
      document.getElementById('fb5-wrong').classList.add('show');
      updateDot(5,false);
    }
    document.getElementById('next5').classList.add('show');
  }
}

function updateWC4(){
  const text=document.getElementById('open4').value.trim();
  const words=text?text.split(/\s+/).length:0;
  document.getElementById('wc4').textContent=words+' ord (minst 15)';
  document.getElementById('submit4').disabled=words<15;
}

function submitOpen(qIdx){
  document.getElementById('compare'+qIdx).classList.add('show');
  document.getElementById('submit'+qIdx).disabled=true;
  document.getElementById('open'+qIdx).disabled=true;
}

function selfAssessQuiz(qIdx, good){
  const pts=good?20:10;
  addPoints(pts);
  qResults[qIdx]=good?true:'partial';
  qPoints[qIdx]=pts;
  updateDot(qIdx, good);
  document.getElementById('sa'+qIdx).innerHTML='<span style="color:var(--success);font-weight:600">+'+pts+' po\u00e4ng!</span>';
  document.getElementById('next'+qIdx).classList.add('show');
  // Save open answer
  const stats=JSON.parse(localStorage.getItem(PREFIX+'pageStats')||'{}');
  stats['del3-quiz-q'+(qIdx+1)+'-answer']=document.getElementById('open'+qIdx).value;
  localStorage.setItem(PREFIX+'pageStats',JSON.stringify(stats));
}

function showHint(qIdx){
  hintsUsed[qIdx]++;
  document.getElementById('hint'+qIdx).classList.add('show');
}

function nextQ(idx){
  document.getElementById('q'+(idx-1)).classList.remove('active');
  document.getElementById('q'+idx).classList.add('active');
  document.getElementById('dot'+idx).classList.add('active');
  currentQ=idx;
}

function updateDot(idx, correct){
  const dot=document.getElementById('dot'+idx);
  dot.classList.remove('active');
  if(correct===true) dot.classList.add('correct');
  else if(correct==='partial') dot.classList.add('partial');
  else dot.classList.add('wrong');
}

function showResults(){
  document.getElementById('q6').classList.remove('active');
  const box=document.getElementById('resultsBox');
  box.classList.add('show');

  const correctCount=qResults.filter(r=>r===true).length;
  const partialCount=qResults.filter(r=>r==='partial').length;

  const scoreEl=document.getElementById('scoreText');
  scoreEl.textContent=correctCount+'/7 r\u00e4tt';
  if(correctCount>=6) scoreEl.classList.add('great');
  else if(correctCount>=4) scoreEl.classList.add('good');
  else scoreEl.classList.add('ok');

  document.getElementById('scoreDetail').textContent=
    'Total po\u00e4ng denna quiz: '+totalQuizPoints+' p | Tid: '+Math.round((Date.now()-startTime)/1000)+' sekunder';

  const grid=document.getElementById('resultGrid');
  const labels=['Avlatsbrev (E)','Bibeln p\u00e5 svenska (C)','Martin ___ (E)','Kyrkans saker (C)','Reformationen & makt (A)','Sant/falskt (E)','Blodbad vs klockor (A)'];
  labels.forEach((label,i)=>{
    const div=document.createElement('div');
    div.className='result-item '+(qResults[i]===true?'right':qResults[i]==='partial'?'partial':'wrong');
    div.textContent=(qResults[i]===true?'R\u00e4tt':qResults[i]==='partial'?'Delvis':'Fel')+': '+label;
    grid.appendChild(div);
  });

  markComplete();
  saveStats();
}

function updateNav(){
  const progress=getProgress();const pages=['del3-01','del3-02','del3-03','del3-04','del3-05','del3-quiz'];let done=0;
  pages.forEach(p=>{const el=document.getElementById('nav-'+p);if(el&&progress[p]){el.classList.add('done');el.querySelector('.icon').innerHTML='&#10003;';done++;}});
  document.getElementById('progressText').textContent=done+'/'+pages.length;
  document.getElementById('progressBar').style.width=Math.round(done/pages.length*100)+'%';
}

function checkPrevious(){
  const progress=getProgress();
  if(progress[PAGE_ID]){
    const stats=JSON.parse(localStorage.getItem(PREFIX+'pageStats')||'{}');
    if(stats[PAGE_ID]){
      document.querySelector('.quiz-info').innerHTML='Du har redan gjort denna quiz! Resultat: '+stats[PAGE_ID].points+' po\u00e4ng. <a href="index.html">Tillbaka till \u00f6versikten</a>';
    }
  }
}

updatePointsDisplay();updateNav();checkPrevious();
</script>
</body>
</html>